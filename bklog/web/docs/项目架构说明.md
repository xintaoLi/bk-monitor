# BK-Log 项目架构说明文档

## 一、项目整体架构

### 1.1 技术栈
- **框架**: Vue 2.x + Vue 3 Composition API (通过 @vue/composition-api)
- **路由**: Vue Router
- **状态管理**: Vuex
- **UI框架**: bk-magic-vue (蓝鲸Magic Vue组件库)
- **构建工具**: Webpack
- **代码编辑器**: CodeMirror (用于SQL/Lucene查询编辑)

### 1.2 项目入口

#### main.js 核心流程
```12:234:bklog/web/src/main.js
// 项目入口文件，负责：
// 1. Vue实例初始化
// 2. 路由配置
// 3. Store初始化
// 4. 全局组件注册
// 5. 预加载数据（空间、菜单等）
```

**关键初始化步骤**：
1. 预加载空间和菜单数据 (`preload`)
2. 动态生成路由配置 (`getRouter`)
3. 创建Vue实例并挂载到 `#app`
4. 注册全局组件和混入

### 1.3 路由架构

#### 路由配置结构 (`router/index.js`)
```71:126:bklog/web/src/router/index.js
// 路由模块化配置：
// - retrieveRoutes: 检索模块路由
// - monitorRoutes: 监控模块路由  
// - dashboardRoutes: 仪表盘模块路由
// - manageRoutes: 管理模块路由（占位）
```

**路由守卫机制**：
- `beforeEach`: 路由切换前取消请求、处理外部跳转
- `afterEach`: 路由切换后上报日志

## 二、Retrieve-V3 模块详细架构

### 2.1 路由入口

#### 路由配置 (`router/retrieve.js`)
```35:85:bklog/web/src/router/retrieve.js
// 检索模块路由配置
// 主路由: /retrieve/:indexId?
// 组件: Retrieve (retrieve-hub.tsx)
```

**路由组件映射**：
- `/retrieve/:indexId?` → `RetrieveHub` → `RetrieveV3`
- `/template-manage` → `TemplateManage`
- `/external-auth/:activeNav?` → `ExternalAuth`
- `/share/:linkId?` → `ShareLink`
- `/data_id/:id?` → `DataIdUrl`

#### 路由入口组件 (`views/retrieve-hub.tsx`)
```32:52:bklog/web/src/views/retrieve-hub.tsx
// 路由入口，根据版本选择渲染 v1 或 v3
// 默认使用 v3 版本
```

### 2.2 Retrieve-V3 主组件结构

#### 主入口 (`views/retrieve-v3/index.tsx`)
```46:129:bklog/web/src/views/retrieve-v3/index.tsx
// 组件层级：
// RetrieveV3 (根组件)
//   ├── V3Collection (收藏夹)
//   └── V3Content (内容区域)
//       ├── V3Toolbar (工具栏)
//       ├── V3Container (容器)
//       │   ├── V3Searchbar (搜索栏)
//       │   └── V3SearchResult (搜索结果)
//       └── AiAssitant (AI助手，可选)
```

**核心功能模块**：
1. **收藏夹模块** (`V3Collection`)
2. **工具栏模块** (`V3Toolbar`)
3. **搜索栏模块** (`V3Searchbar`)
4. **搜索结果模块** (`V3SearchResult`)
5. **AI助手模块** (`AiAssitant`)

### 2.3 模块详细说明

#### 2.3.1 收藏夹模块 (Favorite)

**路径**: `views/retrieve-v3/favorite/`

**组件结构**:
```
favorite/
├── index.tsx              # 主组件 V3Collection
├── collect-main.tsx       # 收藏主内容
├── components/
│   ├── collect-head/      # 收藏头部
│   ├── collect-list/      # 收藏列表
│   │   ├── collect-list.tsx
│   │   ├── add-group.tsx   # 添加分组
│   │   └── edit-dialog.tsx # 编辑对话框
│   ├── collect-tab/        # 收藏标签页
│   ├── collect-tool/       # 收藏工具
│   └── drag-container/     # 拖拽容器
├── hooks/
│   └── use-favorite.ts     # 收藏相关Hook
└── utils/
    └── index.ts            # 工具函数
```

**主要功能**:
- 收藏夹的显示/隐藏控制
- 收藏项的增删改查
- 收藏分组管理
- 可拖拽调整宽度

**关键组件**:
```38:102:bklog/web/src/views/retrieve-v3/favorite/index.tsx
// V3Collection: 收藏夹容器组件
// - 管理收藏夹显示状态
// - 处理宽度变化
// - 集成拖拽功能
```

#### 2.3.2 工具栏模块 (Toolbar)

**路径**: `views/retrieve-v3/toolbar/`

**组件结构**:
```
toolbar/
└── index.tsx              # V3Toolbar 组件
```

**主要功能**:
- 收藏夹显示/隐藏切换按钮
- 集成 V2 版本的 SubBar 组件（二级导航栏）

**关键组件**:
```34:69:bklog/web/src/views/retrieve-v3/toolbar/index.tsx
// V3Toolbar: 工具栏组件
// - 收藏夹切换控制
// - 二级导航栏集成
```

#### 2.3.3 搜索栏模块 (SearchBar)

**路径**: `views/retrieve-v3/search-bar/`

**组件结构**:
```
search-bar/
├── index.tsx              # V3Searchbar 主组件
├── ai-mode/               # AI模式搜索
│   └── index.tsx
└── types.ts               # 类型定义
```

**主要功能**:
- 支持两种搜索模式：
  - **普通模式**: 使用 V2SearchBar (UI模式/SQL模式)
  - **AI模式**: 使用 V3AiMode (自然语言搜索)
- AI编辑功能
- Tab键切换AI模式
- 自然语言转查询语句

**关键组件**:
```46:454:bklog/web/src/views/retrieve-v3/search-bar/index.tsx
// V3Searchbar: 搜索栏主组件
// - 模式切换（normal/ai）
// - AI编辑功能
// - 高度变化监听
// - 自然语言转查询
```

**AI模式组件** (`ai-mode/index.tsx`):
- 自然语言输入
- 实时查询建议
- 过滤器列表管理
- 查询结果展示

#### 2.3.4 搜索结果模块 (SearchResult)

**路径**: `views/retrieve-v3/search-result/`

**组件结构**:
```
search-result/
├── index.tsx                    # V3SearchResult 主组件
├── original-log/                # 原始日志
│   ├── components/
│   │   ├── common-header/       # 通用头部
│   │   ├── data-filter/         # 数据过滤
│   │   │   ├── fields-config/   # 字段配置
│   │   │   └── highlight-control/ # 高亮控制
│   │   └── origin-log-result/   # 原始日志结果
│   │       └── render-json-cell/ # JSON单元格渲染
│   ├── context-log/             # 上下文日志
│   └── real-time-log/           # 实时日志
├── log-clustering/              # 日志聚类
│   ├── index.tsx
│   ├── cluster-start-fail/      # 聚类启动失败
│   ├── empty-cluster/           # 空聚类
│   ├── log-table/               # 日志表格
│   │   ├── content-table/       # 内容表格
│   │   │   ├── cluster-popover/ # 聚类弹窗
│   │   │   │   ├── regex-match/  # 正则匹配
│   │   │   │   └── regex-preview/ # 正则预览
│   │   │   └── remark-edit-tip/  # 备注编辑提示
│   │   └── main-header/         # 主头部
│   │       ├── filter-operate/  # 过滤操作
│   │       └── sort-operate/    # 排序操作
│   ├── quick-open-cluster/      # 快速打开聚类
│   │   └── cluster-access/      # 聚类访问
│   └── top-operation/           # 顶部操作
│       ├── cluster-config/      # 聚类配置
│       ├── cluster-download/    # 聚类下载
│       ├── email-subscription/  # 邮件订阅
│       ├── quick-filter/         # 快速过滤
│       │   ├── dimension-split/  # 维度拆分
│       │   ├── temporary-group/  # 临时分组
│       │   └── time-compare/    # 时间对比
│       └── strategy/             # 策略
└── template-manage/             # 模板管理
    ├── index.tsx
    ├── create-template/          # 创建模板
    ├── index-set-list/           # 索引集列表
    └── template-list/            # 模板列表
```

**主要功能**:
- 多标签页切换（原始日志/图表分析/Grep/聚类）
- 原始日志展示和过滤
- 日志聚类分析
- 模板管理

**关键组件**:
```53:127:bklog/web/src/views/retrieve-v3/search-result/index.tsx
// V3SearchResult: 搜索结果容器
// - 标签页切换（origin/graph_analysis/grep/clustering）
// - 根据tab渲染不同内容
// - 集成V2版本的SearchResultPanel和SearchResultTab
```

**标签页类型**:
- `origin`: 原始日志（默认）
- `graph_analysis`: 图表分析
- `grep`: Grep搜索
- `clustering`: 日志聚类

#### 2.3.5 容器组件 (Container)

**路径**: `views/retrieve-v3/container/`

**组件结构**:
```
container/
├── index.tsx              # V3Container 组件
└── index.scss
```

**主要功能**:
- 提供统一的容器样式
- 包裹搜索栏和搜索结果

**关键组件**:
```30:35:bklog/web/src/views/retrieve-v3/container/index.tsx
// V3Container: 简单容器组件
// - 提供统一的容器样式类
// - 使用插槽渲染子组件
```

#### 2.3.6 Grep模块

**路径**: `views/retrieve-v3/grep/`

**组件结构**:
```
grep/
├── index.tsx              # Grep主组件
├── grep-cli.tsx           # Grep CLI组件
├── grep-cli-editor.tsx    # Grep编辑器
├── grep-cli-result.tsx    # Grep结果
├── grep-highlighter.ts   # 高亮器
└── grep-validator.ts     # 验证器
```

**主要功能**:
- Grep命令行搜索
- 结果高亮显示
- 查询验证

#### 2.3.7 Monitor模块

**路径**: `views/retrieve-v3/monitor/`

**组件结构**:
```
monitor/
├── monitor.tsx            # Monitor主组件
├── apm.ts                 # APM相关
├── trace.ts               # Trace相关
└── use-monitor-app-init.ts # Monitor初始化Hook
```

**主要功能**:
- 监控应用集成
- APM和Trace功能支持

### 2.4 核心Hooks和工具

#### 2.4.1 use-app-init.tsx

**路径**: `views/retrieve-v3/use-app-init.tsx`

**主要功能**:
```40:621:bklog/web/src/views/retrieve-v3/use-app-init.tsx
// 应用初始化Hook，负责：
// 1. 路由参数解析
// 2. 索引集列表获取
// 3. 搜索模式设置
// 4. 滚动位置计算
// 5. 收藏夹状态管理
// 6. 空间切换处理
```

**关键功能**:
- `reoverRouteParams()`: 解析路由参数并更新到store
- `getIndexSetList()`: 获取索引集列表
- `setSearchMode()`: 设置搜索模式（UI/SQL）
- `setDefaultRouteUrl()`: 设置默认路由URL
- 滚动位置监听和吸顶计算

### 2.5 样式文件

**全局样式**:
- `index.scss`: 主样式文件
- `global-en.scss`: 英文环境样式
- `media.scss`: 媒体查询
- `segment-pop.scss`: 分段弹窗样式

## 三、数据流和状态管理

### 3.1 Store结构

**主要状态模块**:
- `retrieve`: 检索相关状态
- `indexItem`: 索引集信息
- `indexFieldInfo`: 字段信息
- `storage`: 本地存储状态
- `aiMode`: AI模式状态

### 3.2 事件通信

**RetrieveHelper事件系统**:
- `RetrieveEvent.SEARCH_VALUE_CHANGE`: 搜索值变化
- `RetrieveEvent.FAVORITE_SHOWN_CHANGE`: 收藏夹显示变化
- `RetrieveEvent.TREND_GRAPH_SEARCH`: 趋势图搜索
- `RetrieveEvent.AI_CLOSE`: AI助手关闭

### 3.3 路由参数同步

**URL参数与Store同步**:
- 通过 `RetrieveUrlResolver` 和 `RouteUrlResolver` 进行参数解析和同步
- 支持查询参数持久化到URL
- 支持从URL恢复查询状态

## 四、组件通信方式

### 4.1 Props/Events
- 父子组件通过props传递数据
- 通过emit事件向上传递数据

### 4.2 Store
- 全局状态通过Vuex管理
- 组件通过 `useStore` Hook访问

### 4.3 RetrieveHelper
- 全局事件总线
- 跨组件通信
- AI助手管理

### 4.4 路由参数
- 通过URL参数共享状态
- 支持浏览器前进后退

## 五、关键功能实现

### 5.1 搜索功能
- **UI模式**: 可视化条件构建
- **SQL模式**: Lucene查询语句
- **AI模式**: 自然语言转查询

### 5.2 结果展示
- 原始日志表格
- 图表分析
- 日志聚类
- Grep搜索

### 5.3 收藏功能
- 收藏查询条件
- 收藏图表
- 分组管理

### 5.4 AI助手
- 自然语言查询
- 查询建议
- 智能编辑

## 六、管理模块（占位）

**说明**: 管理模块暂时忽略，仅占位说明。

**预期结构**:
```
manage/
├── index.tsx              # 管理模块入口
└── [待实现子模块]
```

## 七、技术特点

### 7.1 组件化设计
- 高度模块化
- 组件职责单一
- 易于维护和扩展

### 7.2 版本兼容
- 支持V1和V3版本切换
- 渐进式升级

### 7.3 性能优化
- 路由懒加载
- 虚拟滚动
- 防抖节流
- 按需加载

### 7.4 用户体验
- 响应式设计
- 吸顶效果
- 拖拽调整
- 快捷键支持

## 八、文件组织规范

### 8.1 目录结构
- 按功能模块划分
- 组件、样式、工具分离
- Hooks独立目录

### 8.2 命名规范
- 组件使用PascalCase
- 文件使用kebab-case
- Hook使用use-前缀

### 8.3 代码风格
- TypeScript + JSX
- Composition API
- 函数式编程风格

## 九、数据依赖关系详细分析

### 9.1 核心数据流

#### 9.1.1 数据获取流程

```
索引集选择
    ↓
requestIndexSetFieldInfo (获取字段信息)
    ↓
state.indexFieldInfo 更新
    ↓
resetVisibleFields (生成可见字段列表)
    ↓
state.visibleFields 更新
    ↓
requestIndexSetQuery (获取查询结果)
    ↓
state.indexSetQueryResult 更新
    ↓
搜索结果渲染
```

#### 9.1.2 关键依赖关系

**1. requestIndexSetFieldInfo → requestIndexSetQuery**

**执行顺序**：`requestIndexSetFieldInfo` 必须在 `requestIndexSetQuery` 之前执行

**依赖原因**：
- 查询结果需要字段信息来确定如何解析和展示数据
- 字段信息包含字段类型、别名、排序规则等元数据
- 表格列配置依赖于字段信息

**代码位置**：
```425:439:bklog/web/src/views/retrieve-v3/use-app-init.tsx
// 在 use-app-init.tsx 中的执行顺序
store.dispatch('requestIndexSetFieldInfo')
  .then((resp) => {
    if (resp?.data?.fields?.length) {
      store.dispatch('requestIndexSetQuery').then(() => {
        RetrieveHelper.setSearchingValue(false);
      });
    }
  });
```

**2. indexFieldInfo → visibleFields**

**依赖关系**：`visibleFields` 完全依赖于 `indexFieldInfo.fields` 和 `display_fields`

**生成逻辑**：
```867:887:bklog/web/src/store/index.js
// resetVisibleFields 的实现
resetVisibleFields(state, payload) {
  const filterList = payload || state.indexFieldInfo.display_fields;
  const visibleFields = filterList
    .map((displayName) => {
      const field = state.indexFieldInfo.fields.find(field => field.field_name === displayName);
      if (field) {
        return field;
      }
      return createFieldItem(displayName);
    })
    .filter(Boolean) ?? [];
  store.commit('updateVisibleFields', visibleFields);
}
```

**字段信息结构** (`indexFieldInfo`):
- `fields`: 所有字段列表（包含字段类型、别名、是否内置等）
- `display_fields`: 默认显示的字段列表
- `default_sort_list`: 默认排序规则
- `aggs_items`: 字段聚合统计结果（可选值列表）
- `config_id`: 字段配置ID
- `user_custom_config`: 用户自定义配置

**3. visibleFields + indexSetQueryResult → 表格渲染**

**依赖关系**：表格渲染需要同时使用 `visibleFields` 和 `indexSetQueryResult.list`

**使用场景**：
- `visibleFields`: 确定表格列、列宽、字段类型、格式化规则
- `indexSetQueryResult.list`: 实际的数据行
- `indexSetQueryResult.origin_log_list`: 原始日志数据（用于展开视图）

### 9.2 数据状态结构

#### 9.2.1 indexFieldInfo 状态结构

```javascript
state.indexFieldInfo = {
  fields: [
    {
      field_name: 'dtEventTimeStamp',
      field_type: 'date',
      field_alias: '时间',
      query_alias: 'time',
      is_built_in: true,
      is_analyzed: false,
      es_doc_values: true,
      // ... 其他字段属性
    },
    // ... 更多字段
  ],
  display_fields: ['dtEventTimeStamp', 'log', 'serverIp'],
  default_sort_list: [['dtEventTimeStamp', 'desc']],
  aggs_items: {
    'serverIp': ['192.168.1.1', '192.168.1.2'],
    // ... 字段可选值
  },
  config_id: 123,
  user_custom_config: {
    displayFields: ['dtEventTimeStamp', 'log'],
    // ... 用户配置
  },
  is_loading: false,
  last_eggs_request_token: '1234567890_1234567890',
}
```

#### 9.2.2 indexSetQueryResult 状态结构

```javascript
state.indexSetQueryResult = {
  list: [
    {
      dtEventTimeStamp: 1234567890000,
      log: 'error message',
      serverIp: '192.168.1.1',
      // ... 其他字段数据
    },
    // ... 更多数据行
  ],
  origin_log_list: [
    // 原始日志数据（未处理）
  ],
  total: 1000,
  took: 50,
  is_loading: false,
  is_error: false,
  exception_msg: '',
  search_count: 1,
  union_configs: [], // 联合查询配置
}
```

#### 9.2.3 visibleFields 状态结构

```javascript
state.visibleFields = [
  {
    field_name: 'dtEventTimeStamp',
    field_type: 'date',
    field_alias: '时间',
    minWidth: 200,
    width: 200,
    // ... 从 indexFieldInfo.fields 中复制的属性
  },
  // ... 根据 display_fields 过滤后的字段
]
```

### 9.3 在 search-result/index.tsx 中的使用

#### 9.3.1 组件数据依赖

```53:127:bklog/web/src/views/retrieve-v3/search-result/index.tsx
// V3SearchResult 组件本身不直接使用字段信息
// 但通过 SearchResultPanel 传递给子组件使用
```

**实际使用位置**：
- `SearchResultPanel`: 使用 `visibleFields` 和 `indexSetQueryResult` 渲染表格
- `GraphAnalysis`: 使用字段信息进行图表分析
- `LogClustering`: 使用字段信息进行聚类分析
- `Grep`: 使用字段信息进行Grep搜索

#### 9.3.2 数据传递链路

```
V3SearchResult
    ↓
SearchResultPanel (V2组件)
    ↓
LogResult / LogTable
    ↓
使用 store.state.visibleFields
使用 store.state.indexFieldInfo.fields
使用 store.state.indexSetQueryResult.list
使用 store.state.indexSetQueryResult.origin_log_list
```

### 9.4 性能优化关键点

#### 9.4.1 数据请求优化

**问题**：
1. `requestIndexSetFieldInfo` 和 `requestIndexSetQuery` 串行执行，增加等待时间
2. 字段信息更新后，需要重新计算 `visibleFields`
3. 查询结果更新后，需要重新计算表格列宽

**优化建议**：

1. **并行请求优化**：
   - 如果字段信息已缓存，可以并行请求字段信息和查询结果
   - 使用 Promise.all 并行执行（需要确保字段信息已存在）

2. **字段信息缓存**：
   - 相同索引集的字段信息可以缓存
   - 只在索引集切换或字段配置变更时重新请求

3. **visibleFields 计算优化**：
   - 使用 computed 属性，只在依赖变化时重新计算
   - 避免在每次渲染时重新计算

#### 9.4.2 渲染性能优化

**问题**：
1. 大量数据行导致表格渲染慢
2. 字段信息变化导致整个表格重新渲染
3. 展开视图需要从 `origin_log_list` 中查找数据

**优化建议**：

1. **虚拟滚动**：
   - 已使用 `vue-virtual-scroller`，但需要确保正确配置
   - 限制同时渲染的行数

2. **字段变化优化**：
   - 使用 `Object.freeze` 冻结查询结果（已实现）
   - 字段变化时，只更新受影响的列，而不是整个表格

3. **数据查找优化**：
   - 为 `origin_log_list` 建立索引（rowIndex -> data）
   - 使用 Map 而不是数组查找

#### 9.4.3 状态更新优化

**问题**：
1. 字段信息更新触发多个 mutation
2. 查询结果更新触发大量计算

**优化建议**：

1. **批量更新**：
   - 合并多个 mutation 为一次更新
   - 使用 `nextTick` 延迟非关键更新

2. **计算属性缓存**：
   - 使用 Vue 的 computed 缓存计算结果
   - 避免在模板中直接计算

3. **防抖节流**：
   - 字段配置变更时使用防抖
   - 查询结果更新时使用节流

### 9.5 数据依赖时序图

```
用户操作: 选择索引集
    ↓
[use-app-init.tsx]
    ↓
dispatch('requestIndexSetFieldInfo')
    ↓
[store/index.js]
    ├─ commit('resetIndexFieldInfo')
    ├─ commit('updateIndexFieldInfo', res.data)
    ├─ commit('updataOperatorDictionary', res.data)
    ├─ commit('updateNotTextTypeFields', res.data)
    ├─ commit('updateIndexSetFieldConfig', res.data)
    └─ commit('resetVisibleFields')
        ↓
    commit('updateVisibleFields', visibleFields)
    ↓
[use-app-init.tsx]
    ↓
dispatch('requestIndexSetQuery')
    ↓
[store/index.js]
    ├─ commit('resetIndexSetQueryResult')
    ├─ commit('updateSqlQueryFieldList', logList)
    └─ commit('updateIndexSetQueryResult', rsolvedData)
    ↓
[SearchResultPanel]
    ├─ 使用 visibleFields 渲染列
    ├─ 使用 indexSetQueryResult.list 渲染数据
    └─ 使用 indexFieldInfo.fields 格式化数据
```

### 9.6 关键性能瓶颈

1. **字段信息请求阻塞**：
   - 必须等待字段信息返回才能查询
   - 优化：缓存字段信息，减少请求次数

2. **visibleFields 计算**：
   - 每次字段信息更新都重新计算
   - 优化：使用 computed，只在必要时计算

3. **表格列宽计算**：
   - 每次查询结果更新都重新计算列宽
   - 优化：缓存列宽，只在字段变化时重新计算

4. **大数据量渲染**：
   - 大量数据行导致渲染慢
   - 优化：虚拟滚动 + 分页加载

5. **展开视图数据查找**：
   - 从 origin_log_list 中按索引查找
   - 优化：建立索引映射

### 9.7 优化实施建议

#### 阶段一：快速优化（低风险）
1. 添加字段信息缓存机制
2. 优化 visibleFields 计算（使用 computed）
3. 添加查询结果分页加载

#### 阶段二：中期优化（中风险）
1. 实现字段信息预加载
2. 优化表格列宽计算逻辑
3. 实现数据索引映射

#### 阶段三：深度优化（需测试）
1. 重构数据流，减少不必要的更新
2. 实现增量更新机制
3. 优化虚拟滚动配置

## 十、总结

Retrieve-V3模块采用现代化的Vue 3 Composition API架构，通过模块化设计实现了：
- 清晰的组件层级结构
- 灵活的状态管理
- 完善的用户交互
- 良好的可维护性

**数据依赖关系**：
- `requestIndexSetFieldInfo` 必须在 `requestIndexSetQuery` 之前执行
- `visibleFields` 依赖于 `indexFieldInfo.fields`
- 表格渲染需要 `visibleFields` + `indexSetQueryResult`
- 字段格式化需要 `indexFieldInfo.fields`

**性能优化重点**：
- 字段信息缓存和预加载
- visibleFields 计算优化
- 表格渲染性能优化
- 数据查找优化

整个架构支持多模式搜索、结果展示、收藏管理等核心功能，为日志检索提供了强大的能力支持。
