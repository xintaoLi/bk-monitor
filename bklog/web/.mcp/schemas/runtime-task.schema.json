{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "runtime-task.schema.json",
  "title": "Runtime Task",
  "description": "AI-generated executable test task for front-end autonomous QA",
  "type": "object",
  "required": ["id", "intent", "context", "steps"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^runtime-[a-z0-9]+-\\d{8}-\\d{3}$",
      "description": "Unique task identifier (e.g., runtime-login-20251217-001)",
      "examples": ["runtime-login-20251217-001", "runtime-dashboard-20251217-002"]
    },
    "intent": {
      "type": "string",
      "minLength": 10,
      "description": "AI-level description of what behavior is being validated",
      "examples": [
        "验证登录流程在用户模块变更后仍然可用",
        "检索页面搜索功能在组件重构后是否正常"
      ]
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "AI's confidence score for this task (0-1)",
      "default": 0.5
    },
    "context": {
      "$ref": "#/definitions/context"
    },
    "preconditions": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/precondition"
      },
      "description": "Pre-conditions that must be met before execution"
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/step"
      },
      "description": "Executable MCP steps"
    },
    "signals": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/signal"
      },
      "description": "Observable signals that replace traditional assertions"
    },
    "outcome": {
      "$ref": "#/definitions/outcome"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "createdAt": {
          "type": "string",
          "format": "date-time"
        },
        "createdBy": {
          "enum": ["ai", "rule", "manual"]
        },
        "retryCount": {
          "type": "integer",
          "minimum": 0
        }
      }
    }
  },
  "definitions": {
    "context": {
      "type": "object",
      "required": ["changedFiles"],
      "properties": {
        "changedFiles": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files changed in this commit/PR",
          "examples": [
            ["src/pages/Login.tsx", "src/services/auth.ts"]
          ]
        },
        "affectedComponents": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Components affected by the changes",
          "examples": [
            ["LoginPage", "AuthForm", "SubmitButton"]
          ]
        },
        "affectedRoutes": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Routes that may be impacted",
          "examples": [
            ["/login", "/dashboard"]
          ]
        },
        "commitHash": {
          "type": "string",
          "pattern": "^[a-f0-9]{7,40}$",
          "description": "Git commit hash"
        }
      }
    },
    "precondition": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "enum": ["auth-required", "data-ready", "service-available"]
        },
        "config": {
          "type": "object"
        }
      }
    },
    "step": {
      "oneOf": [
        {
          "type": "object",
          "required": ["type", "url"],
          "properties": {
            "type": {
              "const": "navigate"
            },
            "url": {
              "type": "string",
              "format": "uri-reference"
            },
            "waitUntil": {
              "enum": ["load", "domcontentloaded", "networkidle"]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "selector"],
          "properties": {
            "type": {
              "const": "click"
            },
            "selector": {
              "type": "string"
            },
            "timeout": {
              "type": "number",
              "minimum": 0,
              "default": 30000
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "selector"],
          "properties": {
            "type": {
              "const": "wait"
            },
            "selector": {
              "type": "string"
            },
            "timeout": {
              "type": "number",
              "minimum": 0,
              "default": 30000
            },
            "state": {
              "enum": ["attached", "detached", "visible", "hidden"]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "selector", "value"],
          "properties": {
            "type": {
              "const": "type"
            },
            "selector": {
              "type": "string"
            },
            "value": {
              "type": "string"
            },
            "delay": {
              "type": "number",
              "minimum": 0,
              "description": "Typing delay in ms"
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "script"],
          "properties": {
            "type": {
              "const": "evaluate"
            },
            "script": {
              "type": "string"
            },
            "args": {
              "type": "array"
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "selector"],
          "properties": {
            "type": {
              "const": "select"
            },
            "selector": {
              "type": "string"
            },
            "value": {
              "oneOf": [
                { "type": "string" },
                { "type": "array", "items": { "type": "string" } }
              ]
            }
          },
          "additionalProperties": false
        },
        {
          "type": "object",
          "required": ["type", "selector"],
          "properties": {
            "type": {
              "const": "hover"
            },
            "selector": {
              "type": "string"
            }
          },
          "additionalProperties": false
        }
      ]
    },
    "signal": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "enum": [
            "dom-visible",
            "dom-hidden",
            "route-match",
            "network-idle",
            "no-error-toast",
            "api-success",
            "state-match"
          ]
        },
        "selector": {
          "type": "string",
          "description": "DOM selector for visibility checks"
        },
        "value": {
          "type": "string",
          "description": "Expected value (route, state, etc.)"
        },
        "timeout": {
          "type": "number",
          "minimum": 0,
          "default": 5000
        }
      }
    },
    "outcome": {
      "type": "object",
      "properties": {
        "status": {
          "enum": ["success", "failed", "aborted", "pending"]
        },
        "failedStep": {
          "type": "integer",
          "minimum": 0,
          "description": "Index of failed step"
        },
        "reason": {
          "enum": [
            "selector-not-found",
            "timeout",
            "navigation-failed",
            "script-error",
            "unexpected-route",
            "signal-not-met",
            "precondition-failed"
          ]
        },
        "error": {
          "type": "string",
          "description": "Detailed error message"
        },
        "duration": {
          "type": "number",
          "minimum": 0,
          "description": "Execution time in milliseconds"
        },
        "screenshot": {
          "type": "string",
          "description": "Path to failure screenshot"
        }
      }
    }
  }
}
