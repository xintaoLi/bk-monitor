{
  "$schema": "../schemas/runtime-task.schema.json",
  "id": "main-retrieve-flow",
  "intent": "主业务流程：日志检索完整测试（包含异常场景自愈处理）",
  "context": {
    "component": "LogRetrieve",
    "route": "/retrieve",
    "version": "v3",
    "description": "测试日志检索的主业务流程，包括：un-authorized 自愈、业务切换、索引集选择、UI/语句查询"
  },
  "preconditions": [],
  "steps": [
    {
      "type": "navigate",
      "url": "{{baseUrl}}/#/retrieve",
      "waitUntil": "networkidle2"
    },
    {
      "type": "wait",
      "selector": "body",
      "timeout": 10000,
      "state": "visible"
    },
    {
      "type": "wait",
      "timeout": 5000
    },
    {
      "type": "evaluate",
      "script": "() => { const hash = window.location.hash || ''; console.log('当前路由:', hash); return hash.includes('un-authorized'); }"
    },
    {
      "type": "click",
      "selector": "[data-testid='unauth-retry']",
      "optional": true,
      "timeout": 3000
    },
    {
      "type": "wait",
      "timeout": 3000
    },
    {
      "type": "click",
      "selector": "[data-testid='space-choice-toggle']",
      "optional": true,
      "timeout": 3000
    },
    {
      "type": "wait",
      "timeout": 2000
    },
    {
      "type": "evaluate",
      "script": "() => { const demoBtn = document.querySelector('[data-testid=\"space-choice-demo\"]'); if (demoBtn) { console.log('找到体验DEMO按钮，点击它'); demoBtn.dispatchEvent(new MouseEvent('mousedown', { bubbles: true })); return 'clicked-demo'; } const hash = window.location.hash || ''; const match = hash.match(/spaceUid=([^&]+)/); const currentSpaceUid = match ? match[1] : ''; console.log('当前 spaceUid:', currentSpaceUid); const items = document.querySelectorAll('.biz-list .list-item:not(.checked)'); for (const item of items) { const spaceUid = item.getAttribute('data-space-uid'); if (spaceUid && spaceUid !== currentSpaceUid) { console.log('选择业务:', spaceUid); item.click(); return 'clicked-' + spaceUid; } } console.log('没有找到可切换的业务'); return 'no-switch'; }"
    },
    {
      "type": "wait",
      "timeout": 5000
    },
    {
      "type": "evaluate",
      "script": "() => { const hash = window.location.hash || ''; console.log('切换业务后路由:', hash); return !hash.includes('un-authorized'); }"
    },
    {
      "type": "wait",
      "selector": "[data-testid='v3-search-bar']",
      "timeout": 20000,
      "state": "visible",
      "optional": true
    },
    {
      "type": "wait",
      "timeout": 3000
    },
    {
      "type": "click",
      "selector": "[data-testid='index-set-choice']",
      "optional": true,
      "timeout": 5000
    },
    {
      "type": "wait",
      "timeout": 2000
    },
    {
      "type": "click",
      "selector": ".bk-option:first-child",
      "optional": true,
      "timeout": 3000
    },
    {
      "type": "wait",
      "timeout": 3000
    },
    {
      "type": "evaluate",
      "script": "() => { console.log('页面标题:', document.title); console.log('当前 hash:', window.location.hash); return true; }"
    }
  ],
  "signals": [
    {
      "type": "dom-visible",
      "selector": "[data-testid='v3-search-bar']",
      "timeout": 30000
    }
  ],
  "metadata": {
    "priority": "high",
    "tags": ["main-flow", "retrieve", "business", "e2e", "self-healing"],
    "estimatedDuration": 60000,
    "retryable": true
  }
}
