# æ—¥å¿—æ£€ç´¢ä¸»ä¸šåŠ¡æµ‹è¯•æµç¨‹è¯´æ˜

## ğŸ“‹ æµ‹è¯•ä»»åŠ¡ï¼šmain-retrieve-flow

### æµ‹è¯•ç›®æ ‡
å®Œæ•´æµ‹è¯•æ—¥å¿—æ£€ç´¢çš„ä¸»ä¸šåŠ¡æµç¨‹ï¼ŒåŒ…æ‹¬æ­£å¸¸åœºæ™¯å’Œå¼‚å¸¸åœºæ™¯çš„å¤„ç†ã€‚

---

## ğŸ¯ æµ‹è¯•æ­¥éª¤è¯¦è§£

### æ­¥éª¤ 1ï¼šæ‰“å¼€é¡µé¢
- **æ“ä½œ**ï¼šå¯¼èˆªåˆ° `http://localhost:8081/#/retrieve`
- **ç­‰å¾…**ï¼šé¡µé¢ç½‘ç»œè¯·æ±‚å®Œæˆï¼ˆnetworkidle2ï¼‰

### æ­¥éª¤ 2ï¼šæ£€æŸ¥ç´¢å¼•é›†åˆ—è¡¨
- **æ“ä½œ**ï¼šæ£€æŸ¥å½“å‰ space ä¸‹æ˜¯å¦æœ‰å¯ç”¨çš„ç´¢å¼•é›†
- **æ£€æµ‹å†…å®¹**ï¼š
  - âœ… æ˜¯å¦æœ‰ç´¢å¼•é›†é€‰æ‹©å™¨
  - âŒ æ˜¯å¦æ˜¾ç¤ºé”™è¯¯æç¤º

---

## ğŸ”€ å¼‚å¸¸åœºæ™¯å¤„ç†

### åœºæ™¯ Aï¼šä¸šåŠ¡ä¸‹æ— é‡‡é›†é¡¹

**é”™è¯¯æç¤º**ï¼š
```
ä¸šåŠ¡ä¸‹æ— é‡‡é›†é¡¹ï¼Œè¯·æŒ‰ç…§æŒ‡å¼•å®Œæˆæ¥å…¥ï¼Œæˆ–è”ç³»ç®¡ç†å‘˜ç”³è¯·
```

**å¤„ç†æ­¥éª¤**ï¼š
1. ç‚¹å‡»"æŒ‰ç…§æŒ‡å¼•å®Œæˆæ¥å…¥"é“¾æ¥ï¼ˆå¦‚æœæœ‰ï¼‰
2. å°è¯•ç‚¹å‡»ç´¢å¼•é›†é€‰æ‹©å™¨
3. åˆ‡æ¢åˆ°å…¶ä»–å¯ç”¨ç´¢å¼•é›†

**å¯¹åº”ä»£ç **ï¼š
```json
{
  "type": "conditional",
  "condition": "result.hasError && result.pageText.includes('ä¸šåŠ¡ä¸‹æ— é‡‡é›†é¡¹')",
  "then": [...]
}
```

---

### åœºæ™¯ Bï¼šå½“å‰æ— å¯ç”¨ä¸šåŠ¡ä¿¡æ¯

**é”™è¯¯æç¤º**ï¼š
```
å½“å‰æ— å¯ç”¨ä¸šåŠ¡ä¿¡æ¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ç”³è¯·ï¼ˆç©ºé—´UIDï¼š{id}ï¼Œä¸šåŠ¡IDï¼šï¼‰
æˆ–è€…ç§»é™¤ä¸šåŠ¡å‚æ•°é‡è¯•
```

**å¤„ç†æ­¥éª¤**ï¼š
1. **ç§»é™¤ä¸šåŠ¡å‚æ•°**ï¼šåˆ é™¤ URL ä¸­çš„ `spaceUid` å’Œ `bizId` å‚æ•°
2. **ç­‰å¾…é¡µé¢é‡æ–°åŠ è½½**
3. **é€‰æ‹©ä¸šåŠ¡**ï¼š
   - ç­‰å¾…ä¸šåŠ¡é€‰æ‹©å™¨å‡ºç°
   - ç‚¹å‡»ä¸šåŠ¡é€‰æ‹©å™¨
   - é€‰æ‹©ç¬¬ä¸€ä¸ªæœ‰æ•°æ®çš„ä¸šåŠ¡

**å¯¹åº”ä»£ç **ï¼š
```javascript
// ç§»é™¤ä¸šåŠ¡å‚æ•°
const url = new URL(window.location.href);
url.searchParams.delete('spaceUid');
url.searchParams.delete('bizId');
window.location.href = url.toString();
```

---

## âœ… æ­£å¸¸ä¸šåŠ¡æµç¨‹

### æ­¥éª¤ 5-6ï¼šUI æ¨¡å¼æŸ¥è¯¢

**æ“ä½œæµç¨‹**ï¼š
1. ç­‰å¾…æœç´¢æ åŠ è½½å®Œæˆ
2. åˆ‡æ¢åˆ° UI æ¨¡å¼
3. åœ¨æœç´¢æ¡†è¾“å…¥å…³é”®è¯ï¼š`error`
4. ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®
5. ç­‰å¾…æŸ¥è¯¢ç»“æœ

**é€‰æ‹©å™¨**ï¼š
```css
/* æœç´¢è¾“å…¥æ¡† */
.search-bar input, [class*='search-bar'] input

/* æŸ¥è¯¢æŒ‰é’® */
[class*='query-button'], button[class*='search']

/* UI æ¨¡å¼åˆ‡æ¢ */
[class*='ui-mode'], .ui-mode-tab, text='UIæ¨¡å¼'
```

---

### æ­¥éª¤ 7ï¼šè¯­å¥æ¨¡å¼æŸ¥è¯¢

**æ“ä½œæµç¨‹**ï¼š
1. åˆ‡æ¢åˆ°è¯­å¥æ¨¡å¼
2. åœ¨ SQL ç¼–è¾‘å™¨è¾“å…¥ï¼š`*`ï¼ˆæŸ¥è¯¢æ‰€æœ‰ï¼‰
3. ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®
4. ç­‰å¾…æŸ¥è¯¢ç»“æœ

**é€‰æ‹©å™¨**ï¼š
```css
/* SQL ç¼–è¾‘å™¨ */
.ace_text-input, .code-editor textarea

/* è¯­å¥æ¨¡å¼åˆ‡æ¢ */
[class*='sql-mode'], .sql-mode-tab, text='è¯­å¥æ¨¡å¼'
```

---

## ğŸ“ éªŒè¯ä¿¡å·

æµ‹è¯•ä»»åŠ¡ä½¿ç”¨ä¸¤ä¸ªä¿¡å·æ¥éªŒè¯æˆåŠŸï¼š

### Signal 1: é¡µé¢ä¸»ä½“å¯è§
```json
{
  "type": "dom-visible",
  "selector": "body",
  "timeout": 5000
}
```

### Signal 2: æœç´¢æ å’Œç´¢å¼•é›†å°±ç»ª
```json
{
  "type": "custom",
  "validator": "() => { 
    const searchBar = document.querySelector('.search-bar, [class*=\"search-bar\"]'); 
    const hasIndexSet = !document.body.innerText.includes('ä¸šåŠ¡ä¸‹æ— é‡‡é›†é¡¹'); 
    return !!searchBar && hasIndexSet; 
  }",
  "timeout": 10000
}
```

---

## ğŸš€ è¿è¡Œæµ‹è¯•

### å¿«é€Ÿè¿è¡Œ
```bash
npm run test:now
```

### åªè¿è¡Œä¸»æµç¨‹æµ‹è¯•
```bash
cd packages/mcp-cli
node dist/commands/run.js --task main-retrieve-flow
```

### æŸ¥çœ‹æŠ¥å‘Š
```bash
npm run test:report
```

---

## ğŸ“Š æµ‹è¯•å…ƒæ•°æ®

```json
{
  "priority": "high",
  "tags": ["main-flow", "retrieve", "business", "e2e"],
  "estimatedDuration": 30000,
  "retryable": true
}
```

- **ä¼˜å…ˆçº§**ï¼šé«˜
- **é¢„è®¡è€—æ—¶**ï¼š30 ç§’
- **å¯é‡è¯•**ï¼šæ˜¯

---

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹é¡µé¢çŠ¶æ€
åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// æ£€æŸ¥ç´¢å¼•é›†
document.querySelector('.retrieve-v3-index-set-container, .index-set-selector')

// æ£€æŸ¥é”™è¯¯ä¿¡æ¯
document.body.innerText.includes('ä¸šåŠ¡ä¸‹æ— é‡‡é›†é¡¹')
document.body.innerText.includes('å½“å‰æ— å¯ç”¨ä¸šåŠ¡ä¿¡æ¯')

// æ£€æŸ¥æœç´¢æ 
document.querySelector('.search-bar')
```

### 2. å¯ç”¨è°ƒè¯•æ¨¡å¼
```bash
DEBUG=true npm run test:now
```

### 3. æ…¢é€Ÿæ‰§è¡Œ
ä¿®æ”¹ `.mcp/servers.json`ï¼š
```json
{
  "slowMo": 500  // æ¯ä¸ªæ“ä½œå»¶è¿Ÿ 500ms
}
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ¡ä»¶åˆ¤æ–­**ï¼š
   - ä½¿ç”¨ `conditional` æ­¥éª¤å¤„ç†ä¸åŒåœºæ™¯
   - `optional: true` å…è®¸æ­¥éª¤å¤±è´¥ä¸ä¸­æ–­æµç¨‹

2. **ç­‰å¾…æ—¶é—´**ï¼š
   - é¡µé¢åŠ è½½ï¼š2-3 ç§’
   - æŸ¥è¯¢ç»“æœï¼š2 ç§’
   - ä¸šåŠ¡åˆ‡æ¢ï¼š3 ç§’

3. **é€‰æ‹©å™¨ç­–ç•¥**ï¼š
   - ä¼˜å…ˆä½¿ç”¨ç±»åé€‰æ‹©å™¨
   - å¤‡ç”¨æ–‡æœ¬é€‰æ‹©å™¨ï¼ˆ`text='...'`ï¼‰
   - å¤šä¸ªé€‰æ‹©å™¨é€—å·åˆ†éš”ï¼ˆfallbackï¼‰

4. **å¼‚å¸¸å¤„ç†**ï¼š
   - æ‰€æœ‰å¼‚å¸¸åœºæ™¯æ“ä½œéƒ½æ ‡è®°ä¸º `optional: true`
   - å³ä½¿å¼‚å¸¸å¤„ç†å¤±è´¥ï¼Œä¸»æµç¨‹ä»ä¼šç»§ç»­

---

## ğŸ¬ é¢„æœŸç»“æœ

### æˆåŠŸåœºæ™¯
- âœ… é¡µé¢æ­£å¸¸åŠ è½½
- âœ… ç´¢å¼•é›†åˆ—è¡¨æ˜¾ç¤º
- âœ… UI æ¨¡å¼æŸ¥è¯¢æˆåŠŸ
- âœ… è¯­å¥æ¨¡å¼æŸ¥è¯¢æˆåŠŸ
- âœ… ç»“æœè¡¨æ ¼æ˜¾ç¤º

### å¼‚å¸¸åœºæ™¯å·²å¤„ç†
- âœ… æ— é‡‡é›†é¡¹ â†’ åˆ‡æ¢ç´¢å¼•é›†
- âœ… æ— ä¸šåŠ¡ä¿¡æ¯ â†’ ç§»é™¤å‚æ•°é‡è¯• â†’ é€‰æ‹©ä¸šåŠ¡
- âœ… æ‰€æœ‰å¼‚å¸¸éƒ½æœ‰å…œåº•å¤„ç†

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **[START-HERE.md](../START-HERE.md)** - å¿«é€Ÿå¼€å§‹
- **[TESTING-README.md](../TESTING-README.md)** - æµ‹è¯•ç³»ç»Ÿæ€»è§ˆ
- **[EXECUTION-GUIDE.md](../EXECUTION-GUIDE.md)** - æ‰§è¡Œå¼•æ“è¯¦è§£

---

**æœ€åæ›´æ–°**ï¼š2025-12-18
